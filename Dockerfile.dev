FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./
RUN \
    if [ -f yarn.lock ]; then yarn install --frozen-lockfile && yarn cache clean; \
    elif [ -f package-lock.json ]; then npm ci && npm cache clean --force; \
    elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
    else echo "Warning: Lockfile not found. It is recommended to commit lockfiles to version control." && \
    yarn install && yarn cache clean; \
    fi

# Disable ESLint in dev for faster startup
ENV NEXT_LINT_WARNONLY=true

# Copy source code
COPY . .

# Expose dev server port
EXPOSE 3000

# Default environment variables (can be overridden by docker-compose)
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# Next.js collects completely anonymous telemetry data about general usage.
# Uncomment the following line to disable telemetry at run time
ENV NEXT_TELEMETRY_DISABLED=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# Start Next.js in development mode with HTTPS
CMD \
    if [ -f yarn.lock ]; then yarn dev:https; \
    elif [ -f package-lock.json ]; then npm run dev:https; \
    elif [ -f pnpm-lock.yaml ]; then pnpm dev:https; \
    else yarn dev:https; \
    fi


# Path: tahoe-ui/Dockerfile.dev
# /Users/mshittu/programming-projects/javascript/react/tahoe-ui/Dockerfile.dev